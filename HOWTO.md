# 🎯 Как работает Smart Fuel Tracker

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    RENDER.COM (24/7)                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │         Node.js Bot + Express Server                   │ │
│  │                                                          │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │ │
│  │  │   Parser     │  │  Analytics   │  │   Telegram   │ │ │
│  │  │   Module     │  │    Engine    │  │   Bot API    │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘ │ │
│  │         │                  │                  │         │ │
│  │         ▼                  ▼                  ▼         │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │            JSON Database                         │  │ │
│  │  │  • stations.json  (список заправок)             │  │ │
│  │  │  • database.json  (история цен)                 │  │ │
│  │  │  • users.json     (настройки пользователей)     │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
           ▲                                        │
           │                                        │
    ┌──────┴──────┐                        ┌───────▼────────┐
    │ UptimeRobot │                        │   Telegram     │
    │  (каждые    │                        │  Users 👤👤👤  │
    │   5 минут)  │                        └────────────────┘
    └─────────────┘
```

## 🔄 Процесс работы

### 1️⃣ Автоматическая проверка цен (каждые 5 минут)

```
UptimeRobot → /check-prices → Parser → clever-tanken.de
                                  │
                                  ▼
                         ┌────────────────┐
                         │ Получены цены  │
                         │  CLASSIC: 1.74 │
                         │  HEM: 1.76     │
                         │  BFT: 1.75     │
                         └────────┬───────┘
                                  │
                                  ▼
                      ┌──────────────────────┐
                      │ Сохранение в базу    │
                      │ + временная метка    │
                      │ + день недели        │
                      │ + час                │
                      └──────────┬───────────┘
                                  │
                                  ▼
                      ┌──────────────────────┐
                      │ Проверка целевых цен │
                      └──────────┬───────────┘
                                  │
                     ┌────────────┴────────────┐
                     │                         │
                     ▼                         ▼
          ┌──────────────────┐     ┌──────────────────┐
          │ Цена > цели      │     │ Цена ≤ цели      │
          │ → ничего не шлём │     │ → 🔔 ALERT!      │
          └──────────────────┘     └──────────┬───────┘
                                               │
                                               ▼
                                    ┌──────────────────────┐
                                    │ Telegram уведомление │
                                    │ 🎯 DIESEL: 1.74€     │
                                    │ Цель достигнута!     │
                                    └──────────────────────┘
```

### 2️⃣ Аналитика (по запросу пользователя)

```
User: /analytics → Analytics Engine
                        │
                        ▼
           ┌────────────────────────┐
           │ Загрузка истории       │
           │ за последнюю неделю    │
           └────────┬───────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │ Группировка данных:       │
        │ • По дням недели          │
        │ • По часам суток          │
        │ • По комбинациям (день+час)│
        └───────────┬───────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │ Вычисление средних цен    │
        │                           │
        │ Пн 6:00 → avg 1.739€      │
        │ Пн 7:00 → avg 1.742€      │
        │ Вт 6:00 → avg 1.744€      │
        │ ...                       │
        └───────────┬───────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │ Сортировка по цене        │
        │ Топ-5 лучших слотов       │
        └───────────┬───────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │ Отправка результата:      │
        │ 📊 Лучший день: Понедельник│
        │ ⏰ Лучший час: 6:00       │
        │ 🏆 Топ-5 слотов           │
        └───────────────────────────┘
```

## 💡 Примеры работы

### Пример 1: Алерт по целевой цене

```
День 1, 14:00
User → /settarget diesel 1.76
Bot  → ✅ Целевая цена установлена

...проверка каждые 5 минут...

День 2, 06:15 (цена упала!)
Parser → CLASSIC: diesel 1.74€
Bot    → Проверка целевой цены...
Bot    → 1.74 ≤ 1.76 ✅
Bot    → 🔔 УВЕДОМЛЕНИЕ пользователю!

User получает:
┌──────────────────────────────┐
│ 🎯 DIESEL достиг цели!       │
│ 💰 1.74€ на CLASSIC          │
│ Цель была: 1.76€             │
│                              │
│ 📍 Lokstedter Weg 67         │
│ ⏰ Сейчас: 06:15             │
└──────────────────────────────┘
```

### Пример 2: Недельная аналитика

```
User → /analytics

Bot собирает данные:
┌─────────────────────────────────────┐
│ История: 168 записей (7 дней)       │
│                                     │
│ Понедельник:                        │
│   6:00 → 1.739€, 1.741€, 1.738€    │
│   7:00 → 1.742€, 1.744€            │
│   ...                               │
│ Вторник:                            │
│   6:00 → 1.744€, 1.742€            │
│   ...                               │
└─────────────────────────────────────┘

Анализ:
┌─────────────────────────────────────┐
│ 📊 Результаты для CLASSIC (Diesel)  │
│                                     │
│ 🏆 Лучший день: Понедельник         │
│    Средняя цена: 1.749€             │
│                                     │
│ ⏰ Лучший час: 6:00                 │
│    Средняя цена: 1.745€             │
│                                     │
│ 🎯 Топ-5 слотов:                    │
│ 1. Понедельник 6:00 - 1.739€        │
│ 2. Вторник 7:00 - 1.742€            │
│ 3. Среда 5:00 - 1.744€              │
│ 4. Понедельник 7:00 - 1.745€        │
│ 5. Четверг 6:00 - 1.746€            │
│                                     │
│ 💡 Рекомендация:                    │
│ Заправляйся в понедельник утром!    │
└─────────────────────────────────────┘
```

## 🎯 Стратегия использования

### Краткосрочная (сегодня-завтра)
```
1. Установи целевую цену: /settarget diesel 1.76
2. Жди уведомление
3. Заправляйся когда получишь алерт
```

### Долгосрочная (оптимизация)
```
1. Дай боту собрать данные 5-7 дней
2. Посмотри /analytics
3. Узнай лучшие дни/часы
4. Планируй заправки в оптимальное время
5. Экономия: 0.05€/литр × 50л = 2.50€ на баке!
```

## 📈 Развитие данных

```
День 1-2:  [▓░░░░░░░] Минимум данных
День 3-4:  [▓▓▓░░░░░] Появляются паттерны
День 5-7:  [▓▓▓▓▓░░░] Надёжная статистика
День 8+:   [▓▓▓▓▓▓▓▓] Точные рекомендации
```

## 🔧 Технические детали

### Структура database.json после недели:
```json
{
  "https://www.clever-tanken.de/tankstelle_details/186650": [
    {
      "id": "186650",
      "name": "CLASSIC",
      "prices": { "diesel": 1.739, "e5": 1.849, "e10": 1.829 },
      "timestamp": "2026-02-01T06:15:23.456Z"
    },
    {
      "prices": { "diesel": 1.759, ... },
      "timestamp": "2026-02-01T06:10:18.234Z"
    },
    ... (100 последних записей)
  ],
  "https://...HEM...": [...],
  "https://...BFT...": [...]
}
```

### Структура users.json:
```json
{
  "123456789": {
    "notifications": true,
    "notifyChanges": false,
    "fuelType": "diesel",
    "targets": {
      "diesel": 1.76,
      "e5": null,
      "e10": null
    }
  }
}
```
